<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CareConnect</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/css/styles.css" />
  </head>
  <body>
    <div class="top-container">
      <header>
        <h1 class="logo">
          <span class="blue-c">C</span>are<span class="blue-c">C</span>onnect
        </h1>
      </header>

      <div class="info-box">
        <p>Date: <span id="current-date"></span></p>
        <p>Time: <span id="current-time"></span></p>
        <p>In House: <span id="in-house-display">0</span></p>
        <p>New Admissions: <span id="new-admissions-display">0</span></p>
        <button id="update-info" class="update-button">
          <i class="fas fa-edit"></i> Update Information
        </button>
        <button id="add-staff" class="update-button staff-button">
          <i class="fas fa-user-plus"></i> Add Staff
        </button>
      </div>
    </div>

    <div class="cards-container">
      <div class="card critical" data-type="critical">
        <h2 class="card-title">Critical</h2>
        <i class="fas fa-plus-circle plus-icon"></i>
      </div>
      <div class="card routine" data-type="routine">
        <h2 class="card-title">Routine</h2>
        <i class="fas fa-plus-circle plus-icon"></i>
      </div>
      <div class="card event-based" data-type="event-based">
        <h2 class="card-title">Event-Based</h2>
        <i class="fas fa-plus-circle plus-icon"></i>
      </div>
    </div>

    <a href="dashboard.html" class="dashboard-button">
      <i class="fas fa-chart-line"></i> View Dashboard
    </a>

    <!-- Update Popup -->
    <div id="updatePopup" class="popup">
      <div class="popup-content">
        <span class="close-popup">&times;</span>
        <h2>Update Information</h2>
        <form id="updateForm" onsubmit="return false;">
          <div class="form-group">
            <label for="inHouseCount">In House Count:</label>
            <input type="number" id="inHouseCount" min="0" required />
          </div>
          <div class="form-group">
            <label for="newAdmissions">New Admissions:</label>
            <input type="number" id="newAdmissions" min="0" required />
          </div>
          <button type="submit" class="submit-button">Update</button>
        </form>
      </div>
    </div>

    <!-- Staff Popup Form -->
    <div id="staffPopup" class="popup">
      <div class="popup-content">
        <span class="close-popup">&times;</span>
        <h2>Add New Staff</h2>
        <form id="staffForm" onsubmit="return false;">
          <div class="form-group">
            <label for="staffName">Name:</label>
            <input type="text" id="staffName" required />
          </div>
          <div class="form-group">
            <label for="staffDepartment">Department:</label>
            <select id="staffDepartment" required>
              <option value="">Select Department</option>
              <option value="Catering">Catering</option>
              <option value="Care">Care</option>
              <option value="Admin">Admin</option>
              <option value="Housekeeping">Housekeeping</option>
              <option value="Reception">Reception</option>
            </select>
          </div>
          <div class="form-group">
            <label for="staffRole">Role:</label>
            <select id="staffRole" required>
              <option value="">Select Department First</option>
            </select>
          </div>
          <button type="submit" class="submit-button">Add Staff</button>
        </form>
      </div>
    </div>

    <script>
      // Date and Time Update Function
      function updateDateTime() {
        const now = new Date();
        const dd = String(now.getDate()).padStart(2, "0");
        const mm = String(now.getMonth() + 1).padStart(2, "0");
        const yyyy = now.getFullYear();
        const time = now.toLocaleTimeString();

        document.getElementById(
          "current-date"
        ).textContent = `${dd}/${mm}/${yyyy}`;
        document.getElementById("current-time").textContent = time;
      }

      // Initialize date/time and set interval
      updateDateTime();
      setInterval(updateDateTime, 1000);

      // Fetch counts from database on page load
      async function fetchCounts() {
        try {
          const response = await fetch("/api/counts");
          if (!response.ok) throw new Error("Failed to fetch counts");
          const data = await response.json();

          document.getElementById("in-house-display").textContent =
            data.in_house;
          document.getElementById("new-admissions-display").textContent =
            data.new_admissions;
        } catch (error) {
          console.error("Error fetching counts:", error);
        }
      }

      // Load initial counts
      fetchCounts();

      // Card click handlers
      document.querySelectorAll(".card").forEach((card) => {
        card.addEventListener("click", function () {
          const type = this.getAttribute("data-type");
          window.location.href = `form.html?type=${type}`;
        });
      });

      // Popup elements
      const updateButton = document.getElementById("update-info");
      const popup = document.getElementById("updatePopup");
      const closePopup = document.querySelector(".close-popup");
      const submitButton = document.querySelector(".submit-button");

      // Submit button handler
      submitButton.addEventListener("click", async () => {
        const inHouseCount = document.getElementById("inHouseCount");
        const newAdmissions = document.getElementById("newAdmissions");

        if (inHouseCount.value < 0 || newAdmissions.value < 0) {
          alert("Please enter valid numbers");
          return;
        }

        try {
          const response = await fetch("/api/update-counts", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              inHouse: parseInt(inHouseCount.value),
              newAdmissions: parseInt(newAdmissions.value),
            }),
          });

          if (!response.ok) throw new Error("Failed to update counts");

          // Update display
          document.getElementById("in-house-display").textContent =
            inHouseCount.value;
          document.getElementById("new-admissions-display").textContent =
            newAdmissions.value;

          // Close popup
          popup.classList.remove("active");
        } catch (error) {
          console.error("Error updating counts:", error);
          alert("Failed to update counts. Please try again.");
        }
      });

      // Show popup
      updateButton.addEventListener("click", () => {
        popup.classList.add("active");
      });

      // Close popup
      closePopup.addEventListener("click", () => {
        popup.classList.remove("active");
      });

      // Close popup when clicking outside
      window.addEventListener("click", (event) => {
        if (event.target === popup) {
          popup.classList.remove("active");
        }
      });
    </script>
    <script src="/js/shared.js"></script>
    <script>
      // Initialize InfoManager when the page loads
      document.addEventListener("DOMContentLoaded", async () => {
        try {
          await InfoManager.init();
          console.log("InfoManager initialized successfully");
        } catch (error) {
          console.error("Failed to initialize InfoManager:", error);
        }
      });
    </script>
    <script>
      // Existing staff roles object
      const staffRoles = {
        Catering: [
          "Manager",
          "Head Chef",
          "Sous Chef",
          "Bank Chef",
          "Kitchen Assistant",
          "Waiting Staff",
        ],
        Care: ["Manager", "Senior Carer", "Care Assistant"],
        Admin: ["Admin"],
        Housekeeping: ["Manager", "Assistant"],
        Reception: ["Receptionist"],
      };

      // Staff popup elements
      const addStaffButton = document.getElementById("add-staff");
      const staffPopup = document.getElementById("staffPopup");
      const staffForm = document.getElementById("staffForm");
      const departmentSelect = document.getElementById("staffDepartment");
      const roleSelect = document.getElementById("staffRole");

      // Show staff popup
      addStaffButton.addEventListener("click", () => {
        staffPopup.classList.add("active");
      });

      // Close staff popup when clicking X
      staffPopup.querySelector(".close-popup").addEventListener("click", () => {
        staffPopup.classList.remove("active");
      });

      // Close staff popup when clicking outside
      window.addEventListener("click", (event) => {
        if (event.target === staffPopup) {
          staffPopup.classList.remove("active");
        }
      });

      // Update roles based on selected department
      departmentSelect.addEventListener("change", function () {
        const department = this.value;
        const roles = staffRoles[department] || [];

        // Clear and update role options
        roleSelect.innerHTML = roles.length
          ? roles
              .map((role) => `<option value="${role}">${role}</option>`)
              .join("")
          : '<option value="">Select Department First</option>';
      });

      // Form validation function
      function validateStaffForm() {
        let isValid = true;
        const fields = {
          staffName: "Name is required",
          staffDepartment: "Please select a department",
          staffRole: "Please select a role",
        };

        // Clear previous errors
        document.querySelectorAll(".form-group").forEach((group) => {
          group.classList.remove("error");
          const errorMessage = group.querySelector(".error-message");
          if (errorMessage) errorMessage.remove();
        });

        // Check each field
        for (const [fieldId, message] of Object.entries(fields)) {
          const field = document.getElementById(fieldId);
          if (!field.value.trim()) {
            const formGroup = field.closest(".form-group");
            formGroup.classList.add("error");

            // Add error message
            const errorDiv = document.createElement("div");
            errorDiv.className = "error-message";
            errorDiv.textContent = message;
            formGroup.appendChild(errorDiv);

            isValid = false;
          }
        }

        return isValid;
      }

      // Success notification function
      function showNotification(message, type = "success") {
        const notification = document.createElement("div");
        notification.className = `notification ${type}`;
        notification.innerHTML = `
              <i class="fas ${
                type === "success" ? "fa-check-circle" : "fa-exclamation-circle"
              }"></i>
              ${message}
          `;
        document.body.appendChild(notification);

        // Remove notification after 3 seconds
        setTimeout(() => {
          notification.remove();
        }, 3000);
      }

      // Handle form submission
      staffForm.addEventListener("submit", async function (event) {
        event.preventDefault();

        // Validate form before submission
        if (!validateStaffForm()) {
          return;
        }

        // Get the submit button
        const submitButton = this.querySelector(".submit-button");
        submitButton.disabled = true;
        submitButton.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Adding...';

        try {
          const staffData = {
            name: document.getElementById("staffName").value,
            department: departmentSelect.value,
            role: roleSelect.value,
          };

          const response = await fetch("/api/staff", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(staffData),
          });

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.message || "Failed to add staff member");
          }

          // Show success notification
          showNotification("Staff member added successfully!");

          // Clear form and close popup
          this.reset();
          staffPopup.classList.remove("active");
        } catch (error) {
          console.error("Error:", error);
          showNotification(
            error.message || "Error adding staff member",
            "error"
          );
        } finally {
          // Reset button state
          submitButton.disabled = false;
          submitButton.innerHTML = "Add Staff";
        }
      });
    </script>
  </body>
</html>
